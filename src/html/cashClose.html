<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        /* Reuse styles from index.html */
        .offage-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .offage-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        
        .offage-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .offage-amount {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .offage-balanced { color: #4caf50; }
        .offage-over { color: #ff9800; }
        .offage-short { color: #f44336; }
    </style>
</head>
<body>
    <div class="form-section">
        <h3>Cash Reconciliation & Session Close</h3>
        
        <div class="form-grid">
            <div class="form-group">
                <label>Closet Worker</label>
                <input type="text" id="closeWorker" placeholder="Enter name">
            </div>
            <div class="form-group">
                <label>Actual Amount Deposited</label>
                <input type="number" id="actualDeposit" value="0" step="0.01" onchange="calculateOffage()">
            </div>
        </div>
        
        <!-- Session Summary -->
        <h4>Session Summary</h4>
        <div class="summary-grid">
            <div class="summary-item">
                <span>Starting Cash:</span>
                <span id="summaryStartCash">$0.00</span>
            </div>
            <div class="summary-item">
                <span>Bingo Card Sales:</span>
                <span id="summaryBingoSales">$0.00</span>
            </div>
            <div class="summary-item">
                <span>Pull-Tab Gross:</span>
                <span id="summaryPTGross">$0.00</span>
            </div>
            <div class="summary-item">
                <span>Miscellaneous:</span>
                <span id="summaryMisc">$0.00</span>
            </div>
            <div class="summary-item total">
                <span>Total Gross Receipts:</span>
                <span id="summaryGrossTotal">$0.00</span>
            </div>
        </div>
        
        <div class="summary-grid">
            <div class="summary-item">
                <span>Bingo Prizes Paid:</span>
                <span id="summaryBingoPrizes">$0.00</span>
            </div>
            <div class="summary-item">
                <span>Pull-Tab Prizes Paid:</span>
                <span id="summaryPTPrizes">$0.00</span>
            </div>
            <div class="summary-item total">
                <span>Total Prizes Paid:</span>
                <span id="summaryTotalPrizes">$0.00</span>
            </div>
        </div>
        
        <div class="summary-grid">
            <div class="summary-item total">
                <span>Net Receipts (Expected Deposit):</span>
                <span id="summaryNetReceipts">$0.00</span>
            </div>
        </div>
        
        <!-- Offage Analysis -->
        <div class="offage-section">
            <h4>Offage Analysis</h4>
            <div class="offage-grid">
                <div class="offage-card">
                    <div class="offage-label">Bingo Offage</div>
                    <div class="offage-amount" id="bingoOffage">$0.00</div>
                    <div class="offage-percent" id="bingoOffagePercent">0%</div>
                </div>
                <div class="offage-card">
                    <div class="offage-label">Pull-Tab Offage</div>
                    <div class="offage-amount" id="ptOffage">$0.00</div>
                    <div class="offage-percent" id="ptOffagePercent">0%</div>
                </div>
                <div class="offage-card">
                    <div class="offage-label">Combined Offage</div>
                    <div class="offage-amount" id="combinedOffage">$0.00</div>
                    <div class="offage-status" id="offageStatus">BALANCED</div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Offage Explanation (if any)</label>
                <textarea id="offageExplanation" rows="3" placeholder="Explain any offage..."></textarea>
            </div>
        </div>
        
        <!-- Deposit Information -->
        <h4>Deposit Information</h4>
        <div class="form-grid">
            <div class="form-group">
                <label>Depositor Name</label>
                <input type="text" id="depositorName" placeholder="Enter name">
            </div>
            <div class="form-group">
                <label>Deposit Slip Number</label>
                <input type="text" id="depositSlipNumber" placeholder="Enter slip #">
            </div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="performReconciliation()">
                <i class="material-icons">account_balance</i> Reconcile & Close Session
            </button>
            <button class="btn btn-warning" onclick="refreshSummary()">
                <i class="material-icons">refresh</i> Refresh Summary
            </button>
            <button class="btn btn-success" onclick="generateForm104()">
                <i class="material-icons">description</i> Generate Form 104
            </button>
        </div>
    </div>
    
    <script>
        let sessionSummary = {};
        
        function refreshSummary() {
            google.script.run
                .withSuccessHandler(updateSummaryDisplay)
                .withFailureHandler(console.error)
                .getSessionSummary();
        }
        
        function updateSummaryDisplay(summary) {
            sessionSummary = summary;
            document.getElementById('summaryStartCash').textContent = '$' + (summary.startingCash || 0).toFixed(2);
            document.getElementById('summaryBingoSales').textContent = '$' + (summary.bingoCardSales || 0).toFixed(2);
            document.getElementById('summaryPTGross').textContent = '$' + (summary.pullTabSales || 0).toFixed(2);
            document.getElementById('summaryMisc').textContent = '$' + (summary.miscSales || 0).toFixed(2);
            
            const grossTotal = (summary.startingCash || 0) + (summary.bingoCardSales || 0) + 
                              (summary.pullTabSales || 0) + (summary.miscSales || 0);
            document.getElementById('summaryGrossTotal').textContent = '$' + grossTotal.toFixed(2);
            
            document.getElementById('summaryBingoPrizes').textContent = '$' + (summary.bingoPrizes || 0).toFixed(2);
            document.getElementById('summaryPTPrizes').textContent = '$' + (summary.pullTabPrizes || 0).toFixed(2);
            
            const totalPrizes = (summary.bingoPrizes || 0) + (summary.pullTabPrizes || 0);
            document.getElementById('summaryTotalPrizes').textContent = '$' + totalPrizes.toFixed(2);
            
            const netReceipts = grossTotal - totalPrizes;
            document.getElementById('summaryNetReceipts').textContent = '$' + netReceipts.toFixed(2);
            
            sessionSummary.netReceipts = netReceipts;
        }
        
        function calculateOffage() {
            const actualDeposit = parseFloat(document.getElementById('actualDeposit').value || 0);
            const expectedDeposit = sessionSummary.netReceipts || 0;
            const totalOffage = actualDeposit - expectedDeposit;
            
            // Allocate offage between bingo and pull-tabs
            const bingoRatio = 0.6; // 60% to bingo
            const ptRatio = 0.4; // 40% to pull-tabs
            
            const bingoOffage = totalOffage * bingoRatio;
            const ptOffage = totalOffage * ptRatio;
            
            // Update display
            updateOffageDisplay('bingoOffage', bingoOffage);
            updateOffageDisplay('ptOffage', ptOffage);
            updateOffageDisplay('combinedOffage', totalOffage);
            
            // Update status
            let status = 'BALANCED';
            if (Math.abs(totalOffage) < 5) {
                status = 'BALANCED';
            } else if (totalOffage > 0) {
                status = 'OVER';
            } else {
                status = 'SHORT';
            }
            
            document.getElementById('offageStatus').textContent = status;
            document.getElementById('offageStatus').className = 'offage-status offage-' + status.toLowerCase();
        }
        
        function updateOffageDisplay(elementId, amount) {
            const element = document.getElementById(elementId);
            element.textContent = '$' + Math.abs(amount).toFixed(2);
            
            if (Math.abs(amount) < 5) {
                element.className = 'offage-amount offage-balanced';
            } else if (amount > 0) {
                element.className = 'offage-amount offage-over';
            } else {
                element.className = 'offage-amount offage-short';
            }
        }
        
        function performReconciliation() {
            const reconciliationData = {
                closetWorker: document.getElementById('closeWorker').value,
                actualAmountDeposited: parseFloat(document.getElementById('actualDeposit').value || 0),
                offageExplanation: document.getElementById('offageExplanation').value,
                depositorName: document.getElementById('depositorName').value,
                depositSlipNumber: document.getElementById('depositSlipNumber').value
            };
            
            google.script.run
                .withSuccessHandler(() => {
                    alert('Session reconciled and closed successfully!');
                })
                .withFailureHandler(console.error)
                .performCashReconciliation(currentSession, reconciliationData);
        }
        
        // Load summary on page load
        window.onload = refreshSummary;
    </script>
</body>
</html>
