<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3498db">
    <title>RLC Bingo Manager</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="assets/icons/icon-192.png">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Styles -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f6fa;
            color: #2c3e50;
        }
        
        /* Loading Screen */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #3498db;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        
        #loading.hide {
            opacity: 0;
            pointer-events: none;
        }
        
        .loader-circle {
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 20px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .loader-text {
            color: white;
            font-size: 18px;
        }
        
        /* Header */
        .header {
            background: #3498db;
            color: white;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: bold;
        }
        
        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sync-indicator .online {
            color: #2ecc71;
        }
        
        .sync-indicator .offline {
            color: #e74c3c;
        }
        
        /* Navigation */
        .nav-tabs {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            overflow-x: auto;
        }
        
        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        
        .tab-btn:hover {
            background: #f5f5f5;
        }
        
        .tab-btn.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        /* Content */
        .content {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 16px;
        }
        
        /* Card */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .card-header h3 {
            margin: 0;
            color: #2c3e50;
        }
        
        .card-body {
            padding: 16px;
        }
        
        /* Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            margin-bottom: 4px;
            font-size: 14px;
            color: #666;
        }
        
        .form-control {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #2ecc71;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            background: #2c3e50;
            color: white;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast-success {
            background: #2ecc71;
        }
        
        .toast-error {
            background: #e74c3c;
        }
        
        .toast-warning {
            background: #f39c12;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background: #f5f5f5;
            font-weight: 600;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        /* Error Display */
        .error-container {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 4px;
            padding: 12px;
            margin: 12px 0;
            color: #c00;
        }
        
        .debug-info {
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px;
            margin: 8px 0;
            font-family: monospace;
            font-size: 12px;
        }
        /* Notification Animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .notification {
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 14px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading">
        <div class="loader-circle">RLC</div>
        <div class="loader-text">Loading Bingo Manager...</div>
    </div>
    
    <!-- Main App Container -->
    <div id="app" style="display: none;"></div>
    
    <!-- Third-party Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    
    <!-- Configuration -->
    <script>
        // Configuration for RLC Bingo Manager
        const CONFIG = {
            // Google Apps Script Web App URL
            API_URL: 'https://script.google.com/macros/s/AKfycbzQj-363T7fBf198d6e5uooia0fTLq1dNcdaVcjABZNz9EElL4cZhLXEz2DdfH0YzAYcA/exec',
            
            // App settings
            APP_NAME: 'RLC Bingo Manager',
            VERSION: '9.1.0',
            
            // Storage keys
            STORAGE_KEYS: {
                USER: 'rlc_user',
                TOKEN: 'rlc_token',
                CURRENT_SESSION: 'rlc_current_session',
                SYNC_QUEUE: 'rlc_sync_queue',
                OFFLINE_DATA: 'rlc_offline_data'
            },
            
            // Session types
            SESSION_TYPES: {
                '5-1': '1st/5th Monday',
                '6-2': '2nd Monday',
                '7-3': '3rd Monday',
                '8-4': '4th Monday'
            }
        };
        
        console.log('RLC Bingo Integration initialized - v9.1 Fixed');
    </script>
    
    <!-- Main Application Script -->
    <script>
        // Main Application Class
        class RLCBingoApp {
            constructor() {
                this.db = null;
                this.isOnline = navigator.onLine;
                this.currentTab = 'occasion';
                this.pullTabLibrary = [];
                
                console.log('RLCBingoApp constructor called');
                this.init();
            }
            
            async init() {
                try {
                    console.log('Starting app initialization...');
                    
                    // Initialize database
                    this.db = await this.initDB();
                    console.log('Database initialized');
                    
                    // Set up event listeners
                    this.setupEventListeners();
                    console.log('Event listeners set up');
                    
                    // Try to load pull-tab library
                    await this.loadPullTabLibrary();
                    
                    // Register service worker (optional for now)
                    this.registerServiceWorker();
                    
                    // Hide loading screen and show app
                    this.hideLoading();
                    
                    // Render the application
                    this.render();
                    console.log('App rendered successfully');
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showError('Failed to initialize application', error);
                }
            }
            
            async initDB() {
                return await localforage.createInstance({
                    name: 'RLCBingo',
                    version: 1.0,
                    storeName: 'data'
                });
            }
            
            setupEventListeners() {
                // Online/offline status
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateConnectionStatus();
                    console.log('Back online - processing sync queue...');
                    
                    // Process any queued items
                    this.processSyncQueue();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateConnectionStatus();
                    console.log('Gone offline - data will be queued for sync');
                    
                    this.showNotification('Working offline - data will sync when reconnected', 'info');
                });
                
                // Tab navigation delegation
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-btn')) {
                        e.preventDefault();
                        this.switchTab(e.target.dataset.tab);
                    }
                    
                    // Save button
                    if (e.target.id === 'saveOccasion') {
                        e.preventDefault();
                        this.saveOccasion();
                    }
                    
                    // Add pull-tab game
                    if (e.target.id === 'addPullTab') {
                        e.preventDefault();
                        this.addPullTabRow();
                    }
                });
                
                // Form submissions
                document.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (e.target.id === 'occasionForm') {
                        this.saveOccasion();
                    }
                });
            }
            
            async loadPullTabLibrary() {
                try {
                    console.log('Loading pull-tab library...');
                    // Use the correct endpoint path that doesn't require occasionId
                    const response = await fetch(CONFIG.API_URL + '?path=pulltabs', {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'default'
                    });
                    
                    const data = await response.json();
                    console.log('Pull-tab API response:', data);
                    
                    if (data.success && data.games) {
                        this.pullTabLibrary = data.games;
                        await this.db.setItem('pullTabLibrary', data.games);
                        console.log(`Pull-tab library loaded: ${data.games.length} games`);
                        
                        // Update any dropdowns immediately
                        this.updatePullTabDropdowns();
                    } else if (data.error) {
                        console.error('API Error:', data.error);
                        // Try loading from cache
                        const cached = await this.db.getItem('pullTabLibrary');
                        if (cached && cached.length > 0) {
                            this.pullTabLibrary = cached;
                            console.log('Using cached pull-tab library');
                            this.updatePullTabDropdowns();
                        }
                    }
                } catch (error) {
                    console.error('Failed to load pull-tab library:', error);
                    // Try loading from cache
                    const cached = await this.db.getItem('pullTabLibrary');
                    if (cached) {
                        this.pullTabLibrary = cached;
                        console.log('Using cached pull-tab library');
                    } else {
                        // Use default library
                        this.pullTabLibrary = [
                            { name: 'Hit $250', formNumber: '3440', topPrize: 250, ticketPrice: 1 },
                            { name: 'Lucky Symbols', formNumber: '4000', topPrize: 500, ticketPrice: 1 },
                            { name: 'Wild 10s', formNumber: '3485', topPrize: 100, ticketPrice: 1 },
                            { name: 'Diamond Mine', formNumber: '3980', topPrize: 100, ticketPrice: 1 },
                            { name: 'Super 7-11-21', formNumber: '4424', topPrize: 777, ticketPrice: 1 },
                            { name: '50/50 Raffle', formNumber: '50/50', topPrize: 0, ticketPrice: 1 }
                        ];
                        console.log('Using default pull-tab library');
                    }
                }
            }
            updatePullTabDropdowns() {
                // Update all pull-tab dropdowns with the new data structure
                const selects = document.querySelectorAll('select.pulltab-game');
                selects.forEach(select => {
                    // Clear existing options
                    select.innerHTML = '<option value="">Select a game...</option>';
                    
                    // Add games from library with new field names
                    this.pullTabLibrary.forEach(game => {
                        const option = document.createElement('option');
                        option.value = game.name;  // Now using 'name' instead of 'Game Name'
                        option.textContent = `${game.name} (Form: ${game.form})`;
                        option.dataset.form = game.form;
                        option.dataset.count = game.count;
                        option.dataset.price = game.price;
                        option.dataset.profit = game.profit;
                        option.dataset.idealSales = game.idealSales;
                        option.dataset.idealPrizes = game.idealPrizes;
                        option.dataset.profitPercent = game.profitPercent;
                        select.appendChild(option);
                    });
                });
            }
            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/rlc-bingo-manager/service-worker.js')
                        .then(reg => console.log('Service Worker registered'))
                        .catch(err => console.log('Service Worker registration failed:', err));
                }
            }
            
            hideLoading() {
                const loadingScreen = document.getElementById('loading');
                const appContainer = document.getElementById('app');
                
                if (loadingScreen) {
                    loadingScreen.classList.add('hide');
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 300);
                }
                
                if (appContainer) {
                    appContainer.style.display = 'block';
                }
            }
            
            render() {
                const app = document.getElementById('app');
                if (!app) {
                    console.error('App container not found');
                    return;
                }
                
                app.innerHTML = `
                    <header class="header">
                        <div class="header-content">
                            <div class="logo">
                                <i class="material-icons">casino</i>
                                <span>RLC Bingo Manager</span>
                            </div>
                            <div class="sync-indicator">
                                <span class="${this.isOnline ? 'online' : 'offline'}">
                                    <i class="material-icons">${this.isOnline ? 'cloud_done' : 'cloud_off'}</i>
                                    ${this.isOnline ? 'Online' : 'Offline'}
                                </span>
                            </div>
                        </div>
                    </header>
                    
                    <nav class="nav-tabs">
                        <button class="tab-btn ${this.currentTab === 'occasion' ? 'active' : ''}" data-tab="occasion">
                            <i class="material-icons">event</i> Occasion
                        </button>
                        <button class="tab-btn ${this.currentTab === 'games' ? 'active' : ''}" data-tab="games">
                            <i class="material-icons">games</i> Games
                        </button>
                        <button class="tab-btn ${this.currentTab === 'pulltabs' ? 'active' : ''}" data-tab="pulltabs">
                            <i class="material-icons">confirmation_number</i> Pull-Tabs
                        </button>
                        <button class="tab-btn ${this.currentTab === 'money' ? 'active' : ''}" data-tab="money">
                            <i class="material-icons">attach_money</i> Money Count
                        </button>
                        <button class="tab-btn ${this.currentTab === 'reports' ? 'active' : ''}" data-tab="reports">
                            <i class="material-icons">assessment</i> Reports
                        </button>
                    </nav>
                    
                    <div class="content" id="tabContent">
                        ${this.renderTabContent()}
                    </div>
                `;
            }
            
            renderTabContent() {
                switch (this.currentTab) {
                    case 'occasion':
                        return this.renderOccasionTab();
                    case 'games':
                        return this.renderGamesTab();
                    case 'pulltabs':
                        return this.renderPullTabsTab();
                    case 'money':
                        return this.renderMoneyTab();
                    case 'reports':
                        return this.renderReportsTab();
                    default:
                        return '<div class="card"><div class="card-body">Select a tab to continue</div></div>';
                }
            }
            
            renderOccasionTab() {
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3>Bingo Occasion Information</h3>
                        </div>
                        <div class="card-body">
                            <form id="occasionForm">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Date</label>
                                        <input type="date" class="form-control" name="date" value="${new Date().toISOString().split('T')[0]}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Session Type</label>
                                        <select class="form-control" name="sessionType" required>
                                            <option value="">Select...</option>
                                            ${Object.entries(CONFIG.SESSION_TYPES).map(([key, value]) => 
                                                `<option value="${key}">${value}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Lion in Charge</label>
                                        <input type="text" class="form-control" name="lionInCharge" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Total Players</label>
                                        <input type="number" class="form-control" name="totalPlayers" min="0" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Birthdays</label>
                                        <input type="number" class="form-control" name="birthdays" min="0" value="0">
                                    </div>
                                </div>
                                
                                <div class="card" style="margin-top: 20px; background: #f0f8ff;">
                                    <div class="card-body">
                                        <h4>Progressive Game</h4>
                                        <div class="form-grid">
                                            <div class="form-group">
                                                <label class="form-label">Starting Jackpot</label>
                                                <input type="number" class="form-control" name="progJackpot" step="1" value="500">
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Balls to Win</label>
                                                <input type="number" class="form-control" name="progBalls" value="48">
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Consolation Prize</label>
                                                <input type="number" class="form-control" name="progConsolation" step="1" value="200">
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Actual Balls Called</label>
                                                <input type="number" class="form-control" name="progActualBalls" min="0">
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Prize Awarded</label>
                                                <input type="number" class="form-control" name="progPrize" step="1" value="0">
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">
                                                    <input type="checkbox" name="progCheck"> Check Payment
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px;">
                                    <button type="submit" class="btn btn-primary" id="">
                                        <i class="material-icons">save</i> Save Occasion
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            }
            
            renderGamesTab() {
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3>Session Games</h3>
                        </div>
                        <div class="card-body">
                            <p>Select a session type from the Occasion tab to load games.</p>
                        </div>
                    </div>
                `;
            }
            
            renderPullTabsTab() {
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3>Pull-Tab Games</h3>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Game Name</th>
                                        <th>Serial #</th>
                                        <th>Price</th>
                                        <th>Sold</th>
                                        <th>Revenue</th>
                                        <th>Prizes</th>
                                        <th>Net</th>
                                    </tr>
                                </thead>
                                <tbody id="pullTabsBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; color: #999;">
                                            No pull-tab games added yet
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <button class="btn btn-primary" id="addPullTab" style="margin-top: 10px;">
                                <i class="material-icons">add</i> Add Pull-Tab Game
                            </button>
                            <button class="btn btn-secondary" onclick="app.addCustomPullTab()" style="margin-left: 10px;">
                                <i class="material-icons">add</i> Add Custom Game
                            </button>
                        </div>
                    </div>
                `;
            }
            
            renderMoneyTab() {
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3>Money Count & Reconciliation</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Starting Bank</label>
                                    <input type="number" class="form-control" name="startingBank" value="500" step="1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Cash Total</label>
                                    <input type="number" class="form-control" name="cashTotal" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Checks Total</label>
                                    <input type="number" class="form-control" name="checksTotal" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Deposit Amount</label>
                                    <input type="number" class="form-control" name="depositAmount" step="0.01">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderReportsTab() {
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3>Reports & Analytics</h3>
                        </div>
                        <div class="card-body">
                            <p>Generate MGC reports and financial summaries here.</p>
                            <button class="btn btn-primary">
                                <i class="material-icons">picture_as_pdf</i> Generate MGC Report
                            </button>
                        </div>
                    </div>
                `;
            }
            
            switchTab(tab) {
                this.currentTab = tab;
                this.render();
            }
            
            updateConnectionStatus() {
                const indicator = document.querySelector('.sync-indicator');
                if (indicator) {
                    indicator.innerHTML = `
                        <span class="${this.isOnline ? 'online' : 'offline'}">
                            <i class="material-icons">${this.isOnline ? 'cloud_done' : 'cloud_off'}</i>
                            ${this.isOnline ? 'Online' : 'Offline'}
                        </span>
                    `;
                }
            }
            
            generateOccasionId() {
                // Generate a unique ID for the occasion
                // Format: OCC_YYYYMMDD_HHMMSS_RANDOM
                const now = new Date();
                const dateStr = now.getFullYear().toString() +
                               (now.getMonth() + 1).toString().padStart(2, '0') +
                               now.getDate().toString().padStart(2, '0');
                const timeStr = now.getHours().toString().padStart(2, '0') +
                               now.getMinutes().toString().padStart(2, '0') +
                               now.getSeconds().toString().padStart(2, '0');
                const randomStr = Math.random().toString(36).substr(2, 5).toUpperCase();
                
                return `OCC_${dateStr}_${timeStr}_${randomStr}`;
            }
            
            // saveOccasion method with proper CORS handling
            async saveOccasion() {
                console.log('Saving occasion...');
                
                try {
                    // Collect form data
                    const form = document.getElementById('occasionForm');
                    if (!form) {
                        console.error('Occasion form not found');
                        return;
                    }
                    
                    const formData = new FormData(form);
                    
                    // Build the occasion object with the correct structure for our backend
                    const occasionData = {
                        date: formData.get('date') || new Date().toISOString().split('T')[0],
                        sessionType: formData.get('sessionType') || '',
                        lionInCharge: formData.get('lionInCharge') || '',
                        totalPlayers: parseInt(formData.get('totalPlayers')) || 0,
                        birthdays: parseInt(formData.get('birthdays')) || 0,
                        progressive: {
                            jackpot: parseFloat(formData.get('progJackpot')) || 0,
                            ballsNeeded: parseInt(formData.get('progBalls')) || 48,
                            consolation: parseFloat(formData.get('progConsolation')) || 200,
                            actualBalls: parseInt(formData.get('progActualBalls')) || 0,
                            prizeAwarded: parseFloat(formData.get('progPrize')) || 0,
                            checkPayment: formData.get('progCheck') === 'on'
                        }
                    };
                    
                    // Validate required fields
                    if (!occasionData.sessionType) {
                        alert('Please select a session type');
                        return;
                    }
                    
                    if (!occasionData.lionInCharge) {
                        alert('Please enter the Lion in Charge');
                        return;
                    }
                    
                    // Generate occasion ID if this is a new occasion
                    if (!this.currentOccasion || !this.currentOccasion.id) {
                        this.currentOccasion = {
                            id: this.generateOccasionId(),
                            ...occasionData
                        };
                    } else {
                        // Update existing occasion
                        this.currentOccasion = {
                            ...this.currentOccasion,
                            ...occasionData
                        };
                    }
                    
                    // Save to local storage first
                    await this.db.setItem('currentOccasion', this.currentOccasion);
                    console.log('Occasion saved locally:', this.currentOccasion);
                    
                    // If online, sync to backend
                    if (this.isOnline) {
                        console.log('Syncing occasion to backend...');
                        
                        const response = await fetch(CONFIG.API_URL, {
                            method: 'POST',
                            mode: 'cors',
                            headers: {
                                'Content-Type': 'text/plain',
                            },
                            body: JSON.stringify({
                                path: 'save-occasion',
                                ...occasionData
                            })
                        });
                        
                        const result = await response.json();
                        console.log('Backend response:', result);
                        
                        if (result.success) {
                            // Update local occasion with backend ID if provided
                            if (result.occasionId) {
                                this.currentOccasion.backendId = result.occasionId;
                                await this.db.setItem('currentOccasion', this.currentOccasion);
                            }
                            
                            this.showNotification('Occasion saved successfully!', 'success');
                        } else {
                            throw new Error(result.error || 'Failed to save to backend');
                        }
                    } else {
                        // Queue for sync when online
                        await this.queueForSync('occasion', this.currentOccasion);
                        this.showNotification('Occasion saved locally (will sync when online)', 'info');
                    }
                    
                } catch (error) {
                    console.error('Save error:', error);
                    this.showNotification('Error saving occasion: ' + error.message, 'error');
                }
            }

            showNotification(message, type = 'info') {
                // Create a simple notification element
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                    color: white;
                    border-radius: 4px;
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                `;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
            
            async queueForSync(type, data) {
                // Get existing sync queue
                const syncQueue = (await this.db.getItem('syncQueue')) || [];
                
                // Add new item to queue
                syncQueue.push({
                    type: type,
                    data: data,
                    timestamp: new Date().toISOString(),
                    id: `${type}_${Date.now()}`
                });
                
                // Save updated queue
                await this.db.setItem('syncQueue', syncQueue);
                console.log('Queued for sync:', type, data);
            }
            
            async processSyncQueue() {
                // This method processes the sync queue when coming back online
                const syncQueue = (await this.db.getItem('syncQueue')) || [];
                
                if (syncQueue.length === 0) {
                    console.log('No items in sync queue');
                    return;
                }
                
                console.log(`Processing ${syncQueue.length} items in sync queue...`);
                
                const processed = [];
                
                for (const item of syncQueue) {
                    try {
                        const response = await fetch(CONFIG.API_URL, {
                            method: 'POST',
                            mode: 'cors',
                            headers: {
                                'Content-Type': 'text/plain',
                            },
                            body: JSON.stringify({
                                path: `save-${item.type}`,
                                ...item.data
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            processed.push(item.id);
                            console.log(`Synced ${item.type} successfully`);
                        }
                    } catch (error) {
                        console.error(`Failed to sync ${item.type}:`, error);
                    }
                }
                
                // Remove processed items from queue
                if (processed.length > 0) {
                    const remainingQueue = syncQueue.filter(item => !processed.includes(item.id));
                    await this.db.setItem('syncQueue', remainingQueue);
                    
                    this.showNotification(`Synced ${processed.length} items`, 'success');
                }
            }
            
            // Helper method to save to local storage
            async saveToLocalStorage(occasion) {
                try {
                    // Get existing occasions
                    const occasions = await this.db.getItem('occasions') || [];
                    
                    // Add or update this occasion
                    const existingIndex = occasions.findIndex(o => o.id === occasion.id);
                    if (existingIndex >= 0) {
                        occasions[existingIndex] = occasion;
                    } else {
                        occasions.push(occasion);
                    }
                    
                    // Save back to local storage
                    await this.db.setItem('occasions', occasions);
                    
                    console.log('Saved to local storage:', occasion.id);
                } catch (error) {
                    console.error('Local storage save failed:', error);
                    throw error;
                }
            }
            
            // Helper method to mark an occasion as synced
            async markAsSynced(occasionId) {
                try {
                    const syncStatus = await this.db.getItem('syncStatus') || {};
                    syncStatus[occasionId] = {
                        synced: true,
                        syncedAt: new Date().toISOString()
                    };
                    await this.db.setItem('syncStatus', syncStatus);
                } catch (error) {
                    console.error('Failed to mark as synced:', error);
                }
            }
            
            // Helper method to mark an occasion for future sync
            async markForSync(occasionId) {
                try {
                    const syncQueue = await this.db.getItem('syncQueue') || [];
                    if (!syncQueue.includes(occasionId)) {
                        syncQueue.push(occasionId);
                        await this.db.setItem('syncQueue', syncQueue);
                    }
                    
                    // Also update sync status
                    const syncStatus = await this.db.getItem('syncStatus') || {};
                    syncStatus[occasionId] = {
                        synced: false,
                        needsSync: true,
                        lastAttempt: new Date().toISOString()
                    };
                    await this.db.setItem('syncStatus', syncStatus);
                } catch (error) {
                    console.error('Failed to mark for sync:', error);
                }
            }
            
            // Background sync method (call this periodically or on reconnection)
            async syncPendingOccasions() {
                if (!this.isOnline) return;
                
                try {
                    const syncQueue = await this.db.getItem('syncQueue') || [];
                    if (syncQueue.length === 0) return;
                    
                    console.log('Syncing', syncQueue.length, 'pending occasions');
                    
                    const occasions = await this.db.getItem('occasions') || [];
                    const toSync = occasions.filter(o => syncQueue.includes(o.id));
                    
                    for (const occasion of toSync) {
                        try {
                            // Try regular POST first
                            const response = await fetch(CONFIG.API_URL + '?path=save-occasion', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(occasion)
                            });
                            
                            const result = await response.json();
                            
                            if (result.success) {
                                // Remove from sync queue
                                const index = syncQueue.indexOf(occasion.id);
                                if (index > -1) {
                                    syncQueue.splice(index, 1);
                                }
                                
                                await this.markAsSynced(occasion.id);
                                console.log('Synced occasion:', occasion.id);
                            }
                        } catch (error) {
                            console.error('Failed to sync occasion:', occasion.id, error);
                            // Keep in queue for next attempt
                        }
                    }
                    
                    // Update the sync queue
                    await this.db.setItem('syncQueue', syncQueue);
                    
                    if (syncQueue.length === 0) {
                        this.showToast('All occasions synced successfully', 'success');
                    } else {
                        this.showToast(`${syncQueue.length} occasions pending sync`, 'info');
                    }
                    
                } catch (error) {
                    console.error('Sync process error:', error);
                }
            }
            
            // Initialize periodic sync (call this in your app initialization)
            initializeBackgroundSync() {
                // Check for pending syncs every 30 seconds when online
                setInterval(() => {
                    if (this.isOnline) {
                        this.syncPendingOccasions();
                    }
                }, 30000);
                
                // Also sync when coming back online
                window.addEventListener('online', () => {
                    console.log('Connection restored, attempting sync...');
                    setTimeout(() => this.syncPendingOccasions(), 2000);
                });
            }
            
            addPullTabRow() {
                const tbody = document.getElementById('pullTabTableBody');
                const row = document.createElement('tr');
                row.className = 'pulltab-row';
                row.innerHTML = `
                    <td>
                        <select class="form-control pulltab-game" onchange="app.updatePullTabRow(this)">
                            <option value="">Select game...</option>
                            ${this.pullTabLibrary.map(game => 
                                `<option value="${game.name}" 
                                         data-form="${game.form}" 
                                         data-count="${game.count}"
                                         data-price="${game.price}"
                                         data-profit="${game.profit}"
                                         data-ideal-sales="${game.idealSales}"
                                         data-ideal-prizes="${game.idealPrizes}">
                                    ${game.name} (${game.profitPercent}% profit)
                                </option>`
                            ).join('')}
                        </select>
                    </td>
                    <td class="form-number">-</td>
                    <td><input type="text" class="form-control" placeholder="Serial #"></td>
                    <td><input type="number" class="form-control tickets-sold" min="0" onchange="app.calculatePullTabRow(this)"></td>
                    <td class="gross-sales">$0.00</td>
                    <td><input type="number" class="form-control prizes-paid" min="0" step="0.01" onchange="app.calculatePullTabRow(this)"></td>
                    <td class="net-revenue">$0.00</td>
                    <td><button class="btn btn-sm btn-danger" onclick="app.removePullTabRow(this)">×</button></td>
                `;
                tbody.appendChild(row);
            }

            updatePullTabRow(select) {
                const row = select.closest('tr');
                const formCell = row.querySelector('.form-number');
                const selectedOption = select.selectedOptions[0];
                
                if (selectedOption && selectedOption.value) {
                    formCell.textContent = selectedOption.dataset.form || '-';
                    
                    // Store game data for calculations
                    row.dataset.price = selectedOption.dataset.price || '1';
                    row.dataset.count = selectedOption.dataset.count || '0';
                    row.dataset.profit = selectedOption.dataset.profit || '0';
                    row.dataset.idealSales = selectedOption.dataset.idealSales || '0';
                    row.dataset.idealPrizes = selectedOption.dataset.idealPrizes || '0';
                    
                    // Auto-calculate if tickets are entered
                    const ticketsSold = row.querySelector('.tickets-sold');
                    if (ticketsSold.value) {
                        this.calculatePullTabRow(ticketsSold);
                    }
                } else {
                    formCell.textContent = '-';
                }
            }

            calculatePullTabRow(input) {
                const row = input.closest('tr');
                const ticketsSold = parseInt(row.querySelector('.tickets-sold').value) || 0;
                const prizesPaid = parseFloat(row.querySelector('.prizes-paid').value) || 0;
                const price = parseFloat(row.dataset.price) || 1;
                
                const grossSales = ticketsSold * price;
                const netRevenue = grossSales - prizesPaid;
                
                row.querySelector('.gross-sales').textContent = `$${grossSales.toFixed(2)}`;
                row.querySelector('.net-revenue').textContent = `$${netRevenue.toFixed(2)}`;
                
                // Update totals
                this.calculatePullTabTotals();
            }

            async addCustomPullTab() {
                const gameName = prompt('Enter game name:');
                if (!gameName) return;
                
                const count = parseInt(prompt('Enter ticket count:') || '0');
                if (!count) return;
                
                const profit = parseFloat(prompt('Enter ideal profit amount:') || '0');
                if (!profit) return;
                
                const price = parseFloat(prompt('Enter price per ticket (default $1):') || '1');
                const form = prompt('Enter form number (optional):') || `CUSTOM_${Date.now()}`;
                
                // Add to local library
                const customGame = {
                    name: gameName,
                    form: form,
                    count: count,
                    price: price,
                    profit: profit,
                    url: '',
                    idealSales: count * price,
                    idealPrizes: (count * price) - profit,
                    profitPercent: ((profit / (count * price)) * 100).toFixed(1)
                };
                
                this.pullTabLibrary.push(customGame);
                await this.db.setItem('pullTabLibrary', this.pullTabLibrary);
                
                // Update dropdowns
                this.updatePullTabDropdowns();
                
                // Save to backend if online
                if (this.isOnline) {
                    try {
                        const response = await fetch(CONFIG.API_URL, {
                            method: 'POST',
                            mode: 'cors',
                            headers: {
                                'Content-Type': 'text/plain',
                            },
                            body: JSON.stringify({
                                path: 'save-custom-pulltab',
                                gameData: customGame
                            })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            console.log('Custom game saved to library');
                        }
                    } catch (error) {
                        console.error('Failed to save custom game to backend:', error);
                    }
                }
            }
            
            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            }
            
            showError(message, error) {
                const app = document.getElementById('app');
                if (app) {
                    app.innerHTML = `
                        <div class="error-container">
                            <h3>Error Loading Application</h3>
                            <p>${message}</p>
                            <div class="debug-info">
                                ${error ? error.toString() : 'Unknown error'}
                            </div>
                            <button class="btn btn-primary" onclick="location.reload()">
                                <i class="material-icons">refresh</i> Reload Page
                            </button>
                        </div>
                    `;
                }
                
                // Hide loading screen
                this.hideLoading();
            }
        }
        
        // Initialize app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                window.app = new RLCBingoApp();
            });
        } else {
            // DOM already loaded
            window.app = new RLCBingoApp();
        }
    </script>
</body>
</html>
