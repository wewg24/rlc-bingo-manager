<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>RLC Bingo Manager - Admin Interface</title>

    <!-- Cache control meta tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Styles -->
    <link rel="stylesheet" href="css/style.css?v=11.0.0">
    <link rel="stylesheet" href="css/dark-mode.css?v=11.0.0">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="50x50" href="assets/icons/icon-50.png">
    <link rel="apple-touch-icon" href="assets/icons/icon-50.png">

    <style>
    /* Admin Interface Styles */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f5f5f5;
        color: #333;
        line-height: 1.6;
    }

    .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .header {
        background: linear-gradient(135deg, #2196F3, #1976D2);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header h1 {
        font-size: 2rem;
        margin: 0;
    }

    .header-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .btn {
        background: #2196F3;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        transition: background 0.3s;
    }

    .btn:hover {
        background: #1976D2;
    }

    .btn.secondary {
        background: #6c757d;
    }

    .btn.secondary:hover {
        background: #545b62;
    }

    .btn.success {
        background: #28a745;
    }

    .btn.success:hover {
        background: #218838;
    }

    .btn.warning {
        background: #ffc107;
        color: #212529;
    }

    .btn.warning:hover {
        background: #e0a800;
    }

    .btn.danger {
        background: #dc3545;
    }

    .btn.danger:hover {
        background: #c82333;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #e0e0e0;
    }

    .card h3 {
        margin-bottom: 15px;
        color: #2196F3;
        font-size: 1.25rem;
    }

    .card p {
        margin-bottom: 15px;
        color: #666;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .form-control:focus {
        outline: none;
        border-color: #2196F3;
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .table th,
    .table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }

    .table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }

    .table tbody tr:hover {
        background: #f8f9fa;
    }

    .status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }

    .status.draft {
        background: #fff3cd;
        color: #856404;
    }

    .status.completed {
        background: #d4edda;
        color: #155724;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #2196F3;
        margin-bottom: 5px;
    }

    .stat-label {
        color: #666;
        font-size: 14px;
    }

    .hidden {
        display: none;
    }

    .login-container {
        max-width: 400px;
        margin: 100px auto;
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .login-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .login-header h2 {
        color: #2196F3;
        margin-bottom: 10px;
    }

    .alert {
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
    }

    .alert.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .alert.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .qr-container {
        text-align: center;
        padding: 20px;
    }

    .qr-code {
        background: white;
        padding: 20px;
        border-radius: 8px;
        display: inline-block;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .admin-container {
            padding: 10px;
        }

        .header {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.5rem;
        }

        .grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .table {
            font-size: 14px;
        }

        .table th,
        .table td {
            padding: 8px;
        }
    }

    /* Dark Mode */
    .dark-mode {
        background: #1a1a1a;
        color: #e0e0e0;
    }

    .dark-mode .card,
    .dark-mode .stat-card,
    .dark-mode .table,
    .dark-mode .login-container {
        background: #2a2a2a;
        border-color: #444;
    }

    .dark-mode .table th {
        background: #333;
        color: #e0e0e0;
    }

    .dark-mode .table tbody tr:hover {
        background: #333;
    }

    .dark-mode .form-control {
        background: #333;
        border-color: #555;
        color: #e0e0e0;
    }

    .dark-mode .form-control:focus {
        border-color: #2196F3;
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.3);
    }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <div class="login-header">
            <h2>RLC Bingo Manager</h2>
            <p>Admin Interface</p>
        </div>

        <div id="login-alert" class="alert error hidden"></div>

        <form id="login-form">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Enter username" autocomplete="username" required>
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password" autocomplete="current-password" required>
            </div>

            <button type="submit" class="btn success" style="width: 100%;">Login</button>
        </form>

        <div style="margin-top: 20px; text-align: center; font-size: 12px; color: #666;">
            Demo: Username: RLC, Password: lions1935
        </div>
    </div>
    <!-- Admin Interface -->
    <div id="admin-interface" class="admin-container hidden">
        <div class="header">
            <div>
                <h1>RLC Bingo Manager</h1>
                <p>Administrative Interface</p>
            </div>
            <div class="header-controls">
                <button id="theme-toggle" class="btn secondary">🌙</button>
                <button id="logout-btn" class="btn danger">Logout</button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="card">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn" onclick="showDashboard()">Dashboard</button>
                <button class="btn" onclick="showSessions()">Sessions</button>
                <button class="btn" onclick="showReports()">Reports</button>
                <button class="btn" onclick="showLibrary()">Pull-Tab Library</button>
                <button class="btn warning" onclick="generateOfflineApp()">Generate Offline App</button>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="view">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-sessions">0</div>
                    <div class="stat-label">Total Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-revenue">$0</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-profit">$0</div>
                    <div class="stat-label">Total Profit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-players">0</div>
                    <div class="stat-label">Avg Players</div>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <h3>Quick Actions</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn success" onclick="createSession()">Create New Session</button>
                        <button class="btn" onclick="showReports()">Generate Reports</button>
                        <button class="btn secondary" onclick="backupData()">Backup Data</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Mobile Access</h3>
                    <p>Scan QR code for mobile session entry:</p>
                    <div class="qr-container">
                        <div class="qr-code" id="mobile-qr">
                            <!-- QR code will be generated here -->
                            <img id="qr-image" src="" alt="QR Code" style="width: 150px; height: 150px; border: 1px solid #ddd; display: none;">
                            <div id="qr-placeholder" style="width: 150px; height: 150px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd; flex-direction: column; font-size: 12px; text-align: center;">
                                <div>📱</div>
                                <div>QR Code</div>
                                <div style="margin-top: 5px; font-size: 10px; color: #666;">Loading...</div>
                            </div>
                        </div>
                        <p style="margin-top: 10px; font-size: 12px;" id="mobile-url">https://wewg24.github.io/rlc-bingo-manager/mobile.html</p>
                    </div>
                </div>

                <div class="card">
                    <h3>System Status</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Backend Connection:</span>
                            <span id="backend-status" style="color: green;">●  Online</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Last Sync:</span>
                            <span id="last-sync">Just now</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Offline App Version:</span>
                            <span id="offline-version">11.0.0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sessions View -->
        <div id="sessions-view" class="view hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Session Management</h3>
                    <button class="btn success" onclick="createSession()">New Session</button>
                </div>

                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Session Type</th>
                            <th>Lion in Charge</th>
                            <th>Players</th>
                            <th>Revenue</th>
                            <th>Profit</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sessions-table">
                        <!-- Sessions will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Reports View -->
        <div id="reports-view" class="view hidden">
            <div class="grid">
                <div class="card">
                    <h3>Financial Reports</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn" onclick="generateMonthlyReport()">Monthly Summary</button>
                        <button class="btn" onclick="generateYearlyReport()">Yearly Report</button>
                        <button class="btn" onclick="generateProfitLoss()">Profit & Loss</button>
                        <button class="btn" onclick="generateTaxReport()">Tax Report</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Operational Reports</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn" onclick="generateAttendanceReport()">Attendance Trends</button>
                        <button class="btn" onclick="generateGameAnalysis()">Game Analysis</button>
                        <button class="btn" onclick="generatePullTabReport()">Pull-Tab Performance</button>
                        <button class="btn" onclick="generateVenueReport()">Venue Comparison</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Custom Reports</h3>
                    <div class="form-group">
                        <label>Date Range</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="date" id="report-start" class="form-control">
                            <input type="date" id="report-end" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Report Type</label>
                        <select id="custom-report-type" class="form-control">
                            <option value="summary">Summary Report</option>
                            <option value="detailed">Detailed Report</option>
                            <option value="comparison">Comparison Report</option>
                        </select>
                    </div>
                    <button class="btn success" onclick="generateCustomReport()">Generate Report</button>
                </div>
            </div>
        </div>

        <!-- Pull-Tab Library View -->
        <div id="library-view" class="view hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Pull-Tab Library Management</h3>
                    <button class="btn success" onclick="adminApp.addNewPullTabGame()">Add New Game</button>
                </div>

                <div style="margin-bottom: 20px;">
                    <input type="text" id="library-search" class="form-control" placeholder="Search games..." style="max-width: 300px;">
                </div>

                <table class="table">
                    <thead>
                        <tr>
                            <th>Game Name</th>
                            <th>Ticket Price</th>
                            <th>Tickets per Game</th>
                            <th>Ideal Profit %</th>
                            <th>Manufacturer</th>
                            <th>Form #</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="library-table">
                        <!-- Pull-tab games will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Session Entry/Edit Modal -->
        <div id="session-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center;">
            <div class="card" style="max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 id="session-modal-title">New Session</h3>
                    <button id="modal-close-x" style="background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                </div>

                <form id="session-form">
                    <div class="form-group">
                        <label for="modal-date">Date</label>
                        <input type="date" id="modal-date" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="modal-session-type">Session Type</label>
                        <select id="modal-session-type" class="form-control" required>
                            <option value="">Select...</option>
                            <option value="5-1">5-1 (1st/5th Monday)</option>
                            <option value="6-2">6-2 (2nd Monday)</option>
                            <option value="7-3">7-3 (3rd Monday)</option>
                            <option value="8-4">8-4 (4th Monday)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="modal-lion">Lion in Charge</label>
                        <input type="text" id="modal-lion" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="modal-status">Status</label>
                        <select id="modal-status" class="form-control">
                            <option value="Draft">Draft</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" id="modal-cancel" class="btn secondary">Cancel</button>
                        <button type="submit" class="btn success">Save Session</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Offline App Generator -->
        <div id="offline-generator" class="card hidden">
            <h3>Generate Offline App</h3>
            <p>Create a standalone offline application with current pull-tab library and session configurations.</p>

            <div class="form-group">
                <label for="offline-version">Version</label>
                <input type="text" id="offline-version-input" class="form-control" value="11.0.0" readonly>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="include-library" checked>
                    Include Pull-Tab Library (150+ games)
                </label>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="include-configs" checked>
                    Include Session Configurations
                </label>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="include-forms" checked>
                    Include Blank Form Templates
                </label>
            </div>

            <button class="btn success" onclick="buildOfflineApp()">Generate & Download</button>
            <button class="btn secondary" onclick="previewOfflineApp()">Preview</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/config.js?v=11.0.0"></script>

    <script>
    // Admin Interface JavaScript
    class AdminInterface {
        constructor() {
            this.currentUser = null;
            this.sessions = [];
            this.pullTabLibrary = [];
            this.init();
        }

        init() {
            this.loadSavedState();
            this.setupEventListeners();
            this.checkAuthentication();
        }

        setupEventListeners() {
            // Login form
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleLogin();
            });

            // Logout
            document.getElementById('logout-btn').addEventListener('click', () => {
                this.handleLogout();
            });

            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', () => {
                this.toggleTheme();
            });

            // Session form and modal buttons will be bound after admin interface is shown
        }

        checkAuthentication() {
            const savedUser = localStorage.getItem('rlc_admin_user');
            if (savedUser) {
                this.currentUser = JSON.parse(savedUser);
                this.showAdminInterface();
            } else {
                this.showLoginScreen();
            }
        }

        handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const alert = document.getElementById('login-alert');

            // Simple authentication
            if (username.toUpperCase() === 'RLC' && password === 'lions1935') {
                this.currentUser = { username: 'RLC', loginTime: new Date() };
                localStorage.setItem('rlc_admin_user', JSON.stringify(this.currentUser));
                this.showAdminInterface();
            } else {
                alert.textContent = 'Invalid username or password';
                alert.classList.remove('hidden');
            }
        }

        handleLogout() {
            localStorage.removeItem('rlc_admin_user');
            this.currentUser = null;
            this.showLoginScreen();
        }

        showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('admin-interface').classList.add('hidden');
        }

        showAdminInterface() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-interface').classList.remove('hidden');
            this.loadDashboard();
            this.bindAdminEventListeners();
        }

        bindAdminEventListeners() {
            // Prevent duplicate bindings
            if (this.adminEventsBound) return;
            this.adminEventsBound = true;

            // Session form
            const sessionForm = document.getElementById('session-form');
            if (sessionForm) {
                sessionForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveSession();
                });
            }

            // Modal close buttons
            const closeX = document.getElementById('modal-close-x');
            if (closeX) {
                closeX.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.closeSessionModal();
                });
            }

            const cancelBtn = document.getElementById('modal-cancel');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.closeSessionModal();
                });
            }
        }

        toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('rlc_theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-toggle').textContent = isDark ? '☀️' : '🌙';
        }

        loadSavedState() {
            const theme = localStorage.getItem('rlc_theme');
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-toggle').textContent = '☀️';
            }
        }

        async loadDashboard() {
            try {
                // Load real data from API
                await this.loadRealData();
            } catch (error) {
                console.error('Error loading dashboard:', error);
                this.loadMockData();
            }

            // Generate QR code for mobile access
            this.generateQRCode();
        }

        async loadRealData() {
            const response = await fetch(`${CONFIG.API_URL}?path=occasions`);
            const result = await response.json();

            console.log('API Response:', result); // Debug logging

            if (result.success && result.occasions && Array.isArray(result.occasions)) {
                // Convert API data to admin interface format with correct field mapping
                this.sessions = result.occasions.map(occasion => {
                    console.log('Processing occasion:', occasion); // Debug logging

                    return {
                        id: occasion['Occasion ID'] || `temp_${Date.now()}`,
                        date: this.validateDate(occasion['Date']) || new Date().toISOString().split('T')[0],
                        sessionType: occasion['Session Type'] || 'Unknown',
                        lionInCharge: occasion['Lion in Charge'] || 'N/A',
                        totalPlayers: parseInt(occasion['Total Players']) || 0,
                        // For now, use 0 for revenue/profit until we have those fields calculated
                        totalRevenue: 0,
                        netProfit: 0,
                        status: occasion['Status'] || 'Draft',
                        // Store additional fields for reference
                        progressive: {
                            jackpot: parseFloat(occasion['Progressive Jackpot']) || 0,
                            balls: parseInt(occasion['Progressive Balls']) || 0,
                            consolation: parseFloat(occasion['Progressive Consolation']) || 0,
                            actual: parseFloat(occasion['Progressive Actual']) || 0,
                            prize: parseFloat(occasion['Progressive Prize']) || 0,
                            checkPayment: occasion['Check Payment'] || false
                        },
                        birthdays: parseInt(occasion['Birthdays']) || 0,
                        created: occasion['Created'],
                        createdBy: occasion['Created By']
                    };
                }).filter(session => session.id); // Remove any invalid sessions
            } else {
                console.warn('Invalid API response:', result);
                throw new Error('No valid occasions data received');
            }

            this.updateDashboardStats();
        }

        validateDate(dateStr) {
            if (!dateStr) return null;

            const date = new Date(dateStr);
            if (isNaN(date.getTime())) {
                console.warn('Invalid date:', dateStr);
                return null;
            }

            return dateStr;
        }

        generateQRCode() {
            // Use setTimeout to make QR generation non-blocking
            setTimeout(() => {
                const mobileUrl = 'https://wewg24.github.io/rlc-bingo-manager/mobile.html';
                const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(mobileUrl)}`;

                const qrImage = document.getElementById('qr-image');
                const qrPlaceholder = document.getElementById('qr-placeholder');

                if (qrImage && qrPlaceholder) {
                    qrImage.src = qrApiUrl;
                    qrImage.onload = function() {
                        qrPlaceholder.style.display = 'none';
                        qrImage.style.display = 'block';
                    };
                    qrImage.onerror = function() {
                        qrPlaceholder.innerHTML = '<div>📱</div><div>QR Code</div><div style="margin-top: 5px; font-size: 10px; color: #666;">Error loading QR</div>';
                    };
                }
            }, 100);
        }

        loadMockData() {
            this.sessions = [
                { id: 1, date: '2024-01-15', sessionType: '5-1', lionInCharge: 'John Smith', totalPlayers: 45, totalRevenue: 2240, netProfit: 580, status: 'Completed' },
                { id: 2, date: '2024-01-22', sessionType: '6-2', lionInCharge: 'Jane Doe', totalPlayers: 52, totalRevenue: 2680, netProfit: 720, status: 'Completed' },
                { id: 3, date: '2024-01-29', sessionType: '7-3', lionInCharge: 'Bob Johnson', totalPlayers: 38, totalRevenue: 1920, netProfit: 450, status: 'Draft' }
            ];
            this.updateDashboardStats();
        }

        updateDashboardStats() {
            const totalSessions = this.sessions.length;
            const totalRevenue = this.sessions.reduce((sum, s) => sum + (s.totalRevenue || 0), 0);
            const totalProfit = this.sessions.reduce((sum, s) => sum + (s.netProfit || 0), 0);
            const avgPlayers = totalSessions > 0 ? Math.round(this.sessions.reduce((sum, s) => sum + (s.totalPlayers || 0), 0) / totalSessions) : 0;

            document.getElementById('total-sessions').textContent = totalSessions;
            document.getElementById('total-revenue').textContent = '$' + totalRevenue.toLocaleString();
            document.getElementById('total-profit').textContent = '$' + totalProfit.toLocaleString();
            document.getElementById('avg-players').textContent = avgPlayers;
        }

        showDashboard() {
            this.hideAllViews();
            document.getElementById('dashboard-view').classList.remove('hidden');
            this.loadDashboard();
        }

        showSessions() {
            this.hideAllViews();
            document.getElementById('sessions-view').classList.remove('hidden');
            this.loadSessionsTable();
        }

        showReports() {
            this.hideAllViews();
            document.getElementById('reports-view').classList.remove('hidden');
        }

        showLibrary() {
            this.hideAllViews();
            document.getElementById('library-view').classList.remove('hidden');
            this.loadPullTabLibrary();
        }

        hideAllViews() {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById('offline-generator').classList.add('hidden');
        }

        loadSessionsTable() {
            const tbody = document.getElementById('sessions-table');
            tbody.innerHTML = '';

            if (!this.sessions || this.sessions.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="8" style="text-align: center; padding: 20px; color: #666;">
                        No sessions found. Click "New Session" to create one.
                    </td>
                `;
                return;
            }

            this.sessions.forEach(session => {
                try {
                    const row = tbody.insertRow();

                    // Format date safely
                    const formatDate = (dateStr) => {
                        try {
                            const date = new Date(dateStr);
                            return isNaN(date.getTime()) ? 'Invalid Date' : date.toLocaleDateString();
                        } catch (e) {
                            return 'Invalid Date';
                        }
                    };

                    // Format currency safely
                    const formatCurrency = (value) => {
                        const num = parseFloat(value) || 0;
                        return `$${num.toLocaleString()}`;
                    };

                    row.innerHTML = `
                        <td>${formatDate(session.date)}</td>
                        <td>${CONFIG.SESSION_TYPES[session.sessionType] || session.sessionType || 'Unknown'}</td>
                        <td>${session.lionInCharge || 'N/A'}</td>
                        <td>${parseInt(session.totalPlayers) || 0}</td>
                        <td>${formatCurrency(session.totalRevenue)}</td>
                        <td>${formatCurrency(session.netProfit)}</td>
                        <td><span class="status ${(session.status || 'draft').toLowerCase()}">${session.status || 'Draft'}</span></td>
                        <td>
                            <button class="btn" onclick="adminApp.editSession('${session.id}')">Edit</button>
                            <button class="btn secondary" onclick="adminApp.viewSession('${session.id}')">View</button>
                            <button class="btn danger" onclick="adminApp.deleteSession('${session.id}')">Delete</button>
                        </td>
                    `;
                } catch (error) {
                    console.error('Error rendering session row:', session, error);
                }
            });
        }

        async loadPullTabLibrary() {
            try {
                // Load real pull-tab library data from API
                const response = await fetch(`${CONFIG.API_URL}?path=pulltabs`);
                const result = await response.json();

                console.log('Pull-tab library API response:', result); // Debug logging

                if (result.success && result.games && Array.isArray(result.games)) {
                    this.pullTabLibrary = result.games; // Store for access by other functions
                    this.renderPullTabTable(result.games);
                } else {
                    console.warn('Invalid pull-tab library response:', result);
                    this.loadMockPullTabLibrary();
                }
            } catch (error) {
                console.error('Error loading pull-tab library:', error);
                this.loadMockPullTabLibrary();
            }
        }

        renderPullTabTable(games) {
            const tbody = document.getElementById('library-table');
            tbody.innerHTML = '';

            if (!games || games.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="8" style="text-align: center; padding: 20px; color: #666;">
                        No pull-tab games found in library.
                    </td>
                `;
                return;
            }

            games.forEach((game, index) => {
                try {
                    const row = tbody.insertRow();

                    // Calculate profit percentage if possible
                    const profitPercent = game.price > 0 ? Math.round((game.profit / game.price) * 100) : 0;

                    row.innerHTML = `
                        <td>${game.name || 'Unknown Game'}</td>
                        <td>$${parseFloat(game.price) || 0}</td>
                        <td>${parseInt(game.count) || 0}</td>
                        <td>${profitPercent}%</td>
                        <td>Unknown</td>
                        <td>${game.form || 'N/A'}</td>
                        <td><span class="status active">Active</span></td>
                        <td>
                            <button class="btn" onclick="adminApp.editPullTab('${index}')">Edit</button>
                            <button class="btn secondary" onclick="adminApp.viewPullTabDetails('${index}')">View</button>
                            ${game.url ? `<button class="btn secondary" onclick="window.open('${game.url}', '_blank')">PDF</button>` : ''}
                        </td>
                    `;
                } catch (error) {
                    console.error('Error rendering pull-tab row:', game, error);
                }
            });
        }

        loadMockPullTabLibrary() {
            // Fallback mock data if API fails
            const mockLibrary = [
                { name: 'Lucky 7s', price: 1, count: 300, profit: 0.25, form: 'A7-300', url: '' },
                { name: 'Cash Explosion', price: 2, count: 200, profit: 0.60, form: 'BK-CE-200', url: '' },
                { name: 'Gold Rush', price: 5, count: 100, profit: 1.75, form: 'A-GR-100', url: '' }
            ];

            this.pullTabLibrary = mockLibrary; // Store for access by other functions
            this.renderPullTabTable(mockLibrary);
        }

        viewPullTabDetails(gameIndex) {
            // Get the current games array (either from API or mock)
            const games = this.pullTabLibrary || [];
            const game = games[gameIndex];

            if (!game) {
                this.showAlert('Game not found', 'error');
                return;
            }

            // Create a simple modal showing game details
            const detailsHtml = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;" id="pull-tab-details-modal">
                    <div class="card" style="max-width: 500px; width: 90%; max-height: 80%; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Pull-Tab Game Details</h3>
                            <button onclick="document.getElementById('pull-tab-details-modal').remove()" style="background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                        </div>

                        <div style="display: grid; gap: 15px;">
                            <div><strong>Game Name:</strong> ${game.name || 'Unknown'}</div>
                            <div><strong>Form Number:</strong> ${game.form || 'N/A'}</div>
                            <div><strong>Ticket Price:</strong> $${parseFloat(game.price) || 0}</div>
                            <div><strong>Tickets per Game:</strong> ${parseInt(game.count) || 0}</div>
                            <div><strong>Expected Profit:</strong> $${parseFloat(game.profit) || 0}</div>
                            <div><strong>Profit Percentage:</strong> ${game.price > 0 ? Math.round((game.profit / game.price) * 100) : 0}%</div>
                            ${game.url ? `<div><strong>PDF Document:</strong> <a href="${game.url}" target="_blank" class="btn secondary">View PDF</a></div>` : ''}
                        </div>

                        <div style="margin-top: 20px; text-align: right;">
                            <button onclick="document.getElementById('pull-tab-details-modal').remove()" class="btn secondary">Close</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', detailsHtml);
        }

        addNewPullTabGame() {
            // Create modal for adding new pull-tab game
            const addGameHtml = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;" id="add-pull-tab-modal">
                    <div class="card" style="max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Add New Pull-Tab Game</h3>
                            <button onclick="document.getElementById('add-pull-tab-modal').remove()" style="background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                        </div>

                        <form id="add-pull-tab-form">
                            <div class="form-group">
                                <label for="new-game-name">Game Name *</label>
                                <input type="text" id="new-game-name" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label for="new-game-form">Form Number *</label>
                                <input type="text" id="new-game-form" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label for="new-game-price">Ticket Price *</label>
                                <input type="number" id="new-game-price" class="form-control" step="0.01" min="0" required>
                            </div>

                            <div class="form-group">
                                <label for="new-game-count">Tickets per Game *</label>
                                <input type="number" id="new-game-count" class="form-control" min="1" required>
                            </div>

                            <div class="form-group">
                                <label for="new-game-profit">Expected Profit *</label>
                                <input type="number" id="new-game-profit" class="form-control" step="0.01" min="0" required>
                            </div>

                            <div class="form-group">
                                <label for="new-game-url">PDF URL (optional)</label>
                                <input type="url" id="new-game-url" class="form-control" placeholder="https://...">
                            </div>

                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                <button type="button" class="btn secondary" onclick="document.getElementById('add-pull-tab-modal').remove()">Cancel</button>
                                <button type="submit" class="btn success">Add Game</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', addGameHtml);

            // Handle form submission
            document.getElementById('add-pull-tab-form').addEventListener('submit', (e) => {
                e.preventDefault();
                this.saveNewPullTabGame();
            });
        }

        async saveNewPullTabGame() {
            const formData = {
                name: document.getElementById('new-game-name').value,
                form: document.getElementById('new-game-form').value,
                price: parseFloat(document.getElementById('new-game-price').value),
                count: parseInt(document.getElementById('new-game-count').value),
                profit: parseFloat(document.getElementById('new-game-profit').value),
                url: document.getElementById('new-game-url').value || ''
            };

            try {
                const response = await fetch(`${CONFIG.API_URL}`, {
                    method: 'POST',
                    body: new URLSearchParams({
                        action: 'add-pull-tab-game',
                        data: JSON.stringify(formData)
                    })
                });

                const result = await response.json();

                if (result.success) {
                    this.showAlert('New game added successfully!', 'success');
                    document.getElementById('add-pull-tab-modal').remove();

                    // Refresh the pull-tab library to show the new game
                    await this.loadPullTabLibrary();
                } else {
                    this.showAlert(`Error adding game: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error adding pull-tab game:', error);
                this.showAlert('Error adding game. Please try again.', 'error');
            }
        }

        createSession() {
            this.currentEditingSessionId = null; // Reset editing state
            document.getElementById('session-modal-title').textContent = 'New Session';
            document.getElementById('session-form').reset();
            document.getElementById('modal-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('session-modal').style.display = 'flex';
        }

        editSession(sessionId) {
            const session = this.sessions.find(s => s.id == sessionId);
            if (session) {
                this.currentEditingSessionId = sessionId;
                document.getElementById('session-modal-title').textContent = 'Edit Session';
                document.getElementById('modal-date').value = session.date;
                document.getElementById('modal-session-type').value = session.sessionType;
                document.getElementById('modal-lion').value = session.lionInCharge;
                document.getElementById('modal-status').value = session.status;
                document.getElementById('session-modal').style.display = 'flex';
            }
        }

        async saveSession() {
            const formData = {
                date: document.getElementById('modal-date').value,
                sessionType: document.getElementById('modal-session-type').value,
                lionInCharge: document.getElementById('modal-lion').value,
                totalPlayers: 0,
                status: document.getElementById('modal-status').value || 'Draft'
            };

            // If editing existing session, include the session ID
            if (this.currentEditingSessionId) {
                formData.sessionId = this.currentEditingSessionId;
            }

            try {
                const action = this.currentEditingSessionId ? 'update-session' : 'save-session';
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: action,
                        data: JSON.stringify(formData)
                    })
                });

                const result = await response.json();
                if (result.success && result.data && result.data.success) {
                    this.closeSessionModal();
                    await this.loadSessions(); // Refresh sessions from backend
                    this.showAlert(this.currentEditingSessionId ? 'Session updated successfully!' : 'Session saved successfully!', 'success');
                } else {
                    this.showAlert('Error saving session: ' + (result.error || result.data?.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error saving session:', error);
                this.showAlert('Network error saving session', 'error');
            }
        }

        closeSessionModal() {
            const modal = document.getElementById('session-modal');
            if (modal) {
                modal.style.display = 'none';
            }
            // Reset editing state
            this.currentEditingSessionId = null;
        }

        showAlert(message, type = 'info') {
            // Create alert element if it doesn't exist
            let alertEl = document.getElementById('admin-alert');
            if (!alertEl) {
                alertEl = document.createElement('div');
                alertEl.id = 'admin-alert';
                alertEl.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 4px;
                    color: white;
                    font-weight: 500;
                    z-index: 1001;
                    max-width: 300px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                `;
                document.body.appendChild(alertEl);
            }

            // Set color based on type
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#2196F3'
            };

            alertEl.style.backgroundColor = colors[type] || colors.info;
            alertEl.textContent = message;
            alertEl.style.display = 'block';

            // Auto-hide after 3 seconds
            setTimeout(() => {
                alertEl.style.display = 'none';
            }, 3000);
        }

        async deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this session?')) {
                return;
            }

            try {
                // Call backend API to delete the session
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'delete-session',
                        sessionId: sessionId
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Remove from local array and refresh table
                    this.sessions = this.sessions.filter(s => s.id != sessionId);
                    this.loadSessionsTable();
                    this.showAlert('Session deleted successfully!', 'success');
                } else {
                    throw new Error(result.error || 'Failed to delete session');
                }
            } catch (error) {
                console.error('Error deleting session:', error);
                this.showAlert('Error deleting session: ' + error.message, 'error');
            }
        }

        async viewSession(sessionId) {
            try {
                // Fetch complete session data from backend
                const response = await fetch(`${CONFIG.API_URL}?path=occasion&id=${sessionId}`);
                const result = await response.json();

                if (result.success && result.data) {
                    this.showSessionDetails(result.data);
                } else {
                    this.showAlert('Error loading session details: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error viewing session:', error);
                this.showAlert('Network error loading session details', 'error');
            }
        }

        showSessionDetails(sessionData) {
            const session = sessionData.occasion || {};
            const detailsHtml = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;" id="session-details-modal">
                    <div class="card" style="max-width: 800px; width: 90%; max-height: 80%; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Session Details</h3>
                            <button onclick="document.getElementById('session-details-modal').remove()" style="background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                        </div>

                        <div class="grid grid-2">
                            <div>
                                <h4>Basic Information</h4>
                                <p><strong>Date:</strong> ${session['Date'] ? new Date(session['Date']).toLocaleDateString() : 'N/A'}</p>
                                <p><strong>Session Type:</strong> ${session['Session Type'] || 'N/A'}</p>
                                <p><strong>Lion in Charge:</strong> ${session['Lion in Charge'] || 'N/A'}</p>
                                <p><strong>Total Players:</strong> ${session['Total Players'] || 0}</p>
                                <p><strong>Status:</strong> ${session['Status'] || 'N/A'}</p>
                            </div>
                            <div>
                                <h4>Financial Summary</h4>
                                <p><strong>Total Revenue:</strong> $${(session['Total Revenue'] || 0).toLocaleString()}</p>
                                <p><strong>Net Profit:</strong> $${(session['Net Profit'] || 0).toLocaleString()}</p>
                                <p><strong>Progressive Jackpot:</strong> $${(session['Progressive Jackpot'] || 0).toLocaleString()}</p>
                                <p><strong>Progressive Balls:</strong> ${session['Progressive Balls'] || 0}</p>
                            </div>
                        </div>

                        ${sessionData.games && sessionData.games.length > 0 ? `
                            <div style="margin-top: 20px;">
                                <h4>Game Results</h4>
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Game #</th>
                                            <th>Color</th>
                                            <th>Game Name</th>
                                            <th>Prize</th>
                                            <th>Winners</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sessionData.games.map(game => `
                                            <tr>
                                                <td>${game.number}</td>
                                                <td>${game.color}</td>
                                                <td>${game.name}</td>
                                                <td>$${game.prize}</td>
                                                <td>${game.winners}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button class="btn secondary" onclick="document.getElementById('session-details-modal').remove()">Close</button>
                            <button class="btn" onclick="document.getElementById('session-details-modal').remove(); adminApp.editSession('${session['Occasion ID']}')">Edit Session</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', detailsHtml);
        }

        generateOfflineApp() {
            this.hideAllViews();
            document.getElementById('offline-generator').classList.remove('hidden');
        }

        async buildOfflineApp() {
            const includeLibrary = document.getElementById('include-library').checked;
            const includeConfigs = document.getElementById('include-configs').checked;
            const includeForms = document.getElementById('include-forms').checked;
            const version = document.getElementById('offline-version-input').value;

            try {
                // Start building the offline app
                this.showAlert('Building offline app...', 'info');

                // Get current pull-tab library data
                const libraryData = includeLibrary ? await this.getPullTabLibraryData() : [];

                // Get session configurations
                const configData = includeConfigs ? await this.getSessionConfigs() : {};

                // Generate the offline HTML
                const offlineHTML = this.generateOfflineHTML(libraryData, configData, version, includeForms);

                // Create download
                this.downloadOfflineApp(offlineHTML, version);

                this.showAlert('Offline app generated successfully!', 'success');
            } catch (error) {
                console.error('Error building offline app:', error);
                this.showAlert('Error building offline app', 'error');
            }
        }

        async getPullTabLibraryData() {
            // In a real implementation, this would fetch from the backend
            return [
                { id: 1, name: 'Lucky 7s', ticketPrice: 1, ticketsPerGame: 300, idealProfitPercent: 25, manufacturer: 'Arrow', formNumber: 'A7-300', status: 'Active' },
                { id: 2, name: 'Cash Explosion', ticketPrice: 2, ticketsPerGame: 200, idealProfitPercent: 30, manufacturer: 'Bingo King', formNumber: 'BK-CE-200', status: 'Active' },
                { id: 3, name: 'Gold Rush', ticketPrice: 5, ticketsPerGame: 100, idealProfitPercent: 35, manufacturer: 'Arrow', formNumber: 'A-GR-100', status: 'Active' }
                // In reality, this would include 150+ games
            ];
        }

        async getSessionConfigs() {
            return {
                SESSION_TYPES: CONFIG.SESSION_TYPES,
                PAPER_TYPES: CONFIG.PAPER_TYPES,
                POS_ITEMS: CONFIG.POS_ITEMS
            };
        }

        generateOfflineHTML(libraryData, configData, version, includeForms) {
            const sessionTypesOptions = Object.entries(configData.SESSION_TYPES || {})
                .map(([key, value]) => `<option value="${key}">${value}</option>`)
                .join('');

            const libraryRows = libraryData.map(game => `
                <tr>
                    <td>${game.name}</td>
                    <td>$${game.ticketPrice}</td>
                    <td>${game.ticketsPerGame}</td>
                    <td>${game.idealProfitPercent}%</td>
                    <td>${game.manufacturer}</td>
                    <td>${game.formNumber}</td>
                </tr>
            `).join('');

            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RLC Bingo Manager - Offline App v${version}</title>
    <style>
        /* Embedded CSS for offline use */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; color: #333; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #2196F3, #1976D2); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .offline-badge { background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; display: inline-block; font-size: 12px; }
        .nav { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav button { background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .nav button:hover { background: #1976D2; }
        .nav button.active { background: #1976D2; }
        .view { display: none; }
        .view.active { display: block; }
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .btn { background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px; }
        .btn:hover { background: #1976D2; }
        .btn.success { background: #28a745; }
        .btn.success:hover { background: #218838; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .table th { background: #f8f9fa; font-weight: 600; }
        .print-area { margin-top: 20px; padding: 20px; border: 2px dashed #ccc; background: #fafafa; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>RLC Bingo Manager</h1>
            <div class="offline-badge">Offline App v${version} • Memory-Only Storage</div>
            <p style="margin-top: 10px; font-size: 14px; opacity: 0.9;">Closet Computer Application</p>
        </div>

        <div class="nav no-print">
            <button onclick="showView('session')" class="active">Session Entry</button>
            <button onclick="showView('library')">Pull-Tab Library</button>
            <button onclick="showView('print')">Print Forms</button>
            <button onclick="showView('data')">Data Export</button>
        </div>

        <!-- Session Entry View -->
        <div id="session-view" class="view active">
            <div class="card">
                <h3>Session Data Entry</h3>
                <p>Enter session data from printed forms. Data is stored in browser memory only.</p>

                <form id="session-form">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Session Type</label>
                            <select class="form-control" required>
                                ${sessionTypesOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Lion in Charge</label>
                            <input type="text" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Total Players</label>
                            <input type="number" class="form-control" min="0" required>
                        </div>
                    </div>

                    <button type="submit" class="btn success">Save Session Data</button>
                    <button type="button" class="btn" onclick="printSessionReport()">Print Report</button>
                </form>
            </div>
        </div>

        <!-- Pull-Tab Library View -->
        <div id="library-view" class="view">
            <div class="card">
                <h3>Pull-Tab Library (${libraryData.length} games)</h3>
                <input type="text" id="library-search" class="form-control" placeholder="Search games..." style="max-width: 300px; margin-bottom: 15px;">

                <table class="table">
                    <thead>
                        <tr>
                            <th>Game Name</th>
                            <th>Price</th>
                            <th>Tickets</th>
                            <th>Profit %</th>
                            <th>Manufacturer</th>
                            <th>Form #</th>
                        </tr>
                    </thead>
                    <tbody id="library-table">
                        ${libraryRows}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Print Forms View -->
        <div id="print-view" class="view">
            <div class="card">
                <h3>Print Blank Forms</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <button class="btn" onclick="printBlankForm('occasion')">Occasion Report</button>
                    <button class="btn" onclick="printBlankForm('money')">Money Summary</button>
                    <button class="btn" onclick="printBlankForm('pulltab')">Pull-Tab Summary</button>
                    <button class="btn" onclick="printBlankForm('games')">Games Sheet</button>
                </div>

                <div id="print-preview" class="print-area" style="display: none;">
                    <h4>Form Preview</h4>
                    <div id="form-content"></div>
                    <button class="btn no-print" onclick="window.print()">Print</button>
                </div>
            </div>
        </div>

        <!-- Data Export View -->
        <div id="data-view" class="view">
            <div class="card">
                <h3>Data Export</h3>
                <p>Export completed session data for upload to main system.</p>

                <div style="margin: 20px 0;">
                    <button class="btn" onclick="exportSessionData()">Export as JSON</button>
                    <button class="btn" onclick="exportSessionCSV()">Export as CSV</button>
                    <button class="btn" onclick="clearAllData()">Clear All Data</button>
                </div>

                <div id="export-output" style="background: #f8f9fa; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Embedded JavaScript for offline functionality
        const OFFLINE_DATA = {
            pullTabLibrary: ${JSON.stringify(libraryData)},
            config: ${JSON.stringify(configData)},
            version: '${version}',
            sessions: []
        };

        // Initialize offline app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('RLC Bingo Manager Offline App v' + OFFLINE_DATA.version + ' loaded');
            initializeLibrarySearch();
        });

        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });

            // Remove active class from nav buttons
            document.querySelectorAll('.nav button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected view
            document.getElementById(viewName + '-view').classList.add('active');
            event.target.classList.add('active');
        }

        function initializeLibrarySearch() {
            const searchInput = document.getElementById('library-search');
            const tableBody = document.getElementById('library-table');

            if (searchInput && tableBody) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const rows = tableBody.querySelectorAll('tr');

                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
            }
        }

        function saveSessionData() {
            // Save form data to memory
            const formData = new FormData(document.getElementById('session-form'));
            const sessionData = Object.fromEntries(formData);
            sessionData.id = Date.now();
            sessionData.timestamp = new Date().toISOString();

            OFFLINE_DATA.sessions.push(sessionData);
            alert('Session data saved to memory!');
        }

        function exportSessionData() {
            const output = document.getElementById('export-output');
            output.textContent = JSON.stringify(OFFLINE_DATA.sessions, null, 2);
            output.style.display = 'block';
        }

        function clearAllData() {
            if (confirm('Clear all session data? This cannot be undone.')) {
                OFFLINE_DATA.sessions = [];
                alert('All data cleared.');
            }
        }

        function printBlankForm(formType) {
            // Generate blank form HTML for printing
            let formHTML = '';

            switch(formType) {
                case 'occasion':
                    formHTML = generateOccasionForm();
                    break;
                case 'money':
                    formHTML = generateMoneyForm();
                    break;
                case 'pulltab':
                    formHTML = generatePullTabForm();
                    break;
                case 'games':
                    formHTML = generateGamesForm();
                    break;
            }

            document.getElementById('form-content').innerHTML = formHTML;
            document.getElementById('print-preview').style.display = 'block';
        }

        function generateOccasionForm() {
            return '<h3>RLC Bingo Occasion Report</h3><p>Date: _______________</p><p>Session: _______________</p><p>Lion in Charge: _______________</p>';
        }

        function generateMoneyForm() {
            return '<h3>RLC Money Summary Sheet</h3><table style="width:100%; border: 1px solid #000;"><tr><th>Denomination</th><th>Count</th><th>Total</th></tr><tr><td>$100s</td><td>____</td><td>____</td></tr></table>';
        }

        function generatePullTabForm() {
            return '<h3>RLC Pull-Tab Nightly Summary</h3><p>Date: _______________</p><p>Lion in Charge: _______________</p>';
        }

        function generateGamesForm() {
            return '<h3>RLC Bingo Games Sheet</h3><p>Session: _______________</p><p>Date: _______________</p>';
        }

        // Form submission handled by AdminApp class
    <\/script>
</body>
</html>`;
        }

        downloadOfflineApp(htmlContent, version) {
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `rlc-bingo-offline-v${version}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        editPullTab(gameIndex) {
            // Find the game in the real pull-tab library by index
            const game = this.pullTabLibrary[gameIndex];
            if (game) {
                const modal = this.createEditPullTabModal(game, gameIndex);
                document.body.appendChild(modal);
            } else {
                this.showAlert('Pull-tab game not found', 'error');
            }
        }

        createEditPullTabModal(game, gameIndex) {
            const modal = document.createElement('div');
            modal.id = 'edit-pulltab-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;

            // Build form HTML with proper variable interpolation
            const formHTML = `
                <div class="card" style="max-width: 500px; width: 90%; max-height: 80%; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Edit Pull-Tab Game</h3>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                    </div>

                    <form id="edit-pulltab-form">
                        <div class="form-group">
                            <label>Game Name</label>
                            <input type="text" name="name" class="form-control" value="${game.name || ''}" required>
                        </div>

                        <div class="form-group">
                            <label>Ticket Price</label>
                            <select name="price" class="form-control" required>
                                <option value="0.25" ${game.price == 0.25 ? 'selected' : ''}>$0.25</option>
                                <option value="0.50" ${game.price == 0.50 ? 'selected' : ''}>$0.50</option>
                                <option value="1" ${game.price == 1 ? 'selected' : ''}>$1.00</option>
                                <option value="2" ${game.price == 2 ? 'selected' : ''}>$2.00</option>
                                <option value="5" ${game.price == 5 ? 'selected' : ''}>$5.00</option>
                                <option value="10" ${game.price == 10 ? 'selected' : ''}>$10.00</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Tickets per Game</label>
                            <input type="number" name="count" class="form-control" value="${game.count || ''}" required min="1">
                        </div>

                        <div class="form-group">
                            <label>Expected Profit ($)</label>
                            <input type="number" name="profit" class="form-control" value="${game.profit || ''}" required min="0" step="0.01">
                        </div>

                        <div class="form-group">
                            <label>Form Number</label>
                            <input type="text" name="form" class="form-control" value="${game.form || ''}" required>
                        </div>

                        <div class="form-group">
                            <label>PDF URL (optional)</label>
                            <input type="url" name="url" class="form-control" value="${game.url || ''}" placeholder="https://...">
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="btn secondary" onclick="this.closest('#edit-pulltab-modal').remove()">Cancel</button>
                            <button type="submit" class="btn success">Save Changes</button>
                        </div>
                    </form>
                </div>
            `;

            modal.innerHTML = formHTML;

            modal.querySelector('#edit-pulltab-form').addEventListener('submit', (e) => {
                e.preventDefault();
                this.savePullTabEdit(gameIndex, modal);
            });

            return modal;
        }

        async savePullTabEdit(gameIndex, modal) {
            const formData = new FormData(modal.querySelector('form'));

            try {
                // Get the current game data
                const currentGame = this.pullTabLibrary[gameIndex];

                // Prepare data for API call
                const gameData = {
                    index: gameIndex,
                    name: formData.get('name'),
                    price: parseFloat(formData.get('price')),
                    count: parseInt(formData.get('count')),
                    profit: parseFloat(formData.get('profit')),
                    form: formData.get('form'),
                    url: formData.get('url') || ''
                };

                console.log('Saving pull-tab edit for game index:', gameIndex, gameData);

                // Call backend API to update the game
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'update-pull-tab-game',
                        gameIndex: gameIndex,
                        data: JSON.stringify(gameData)
                    })
                });

                const result = await response.json();

                if (result.success) {
                    modal.remove();
                    this.loadPullTabLibrary(); // Refresh the library
                    this.showAlert('Pull-tab game updated successfully!', 'success');
                } else {
                    throw new Error(result.error || 'Failed to update pull-tab game');
                }
            } catch (error) {
                console.error('Error saving pull-tab edit:', error);
                this.showAlert('Error updating pull-tab game: ' + error.message, 'error');
            }
        }

        async deletePullTab(gameId) {
            if (!confirm('Are you sure you want to delete this pull-tab game?')) {
                return;
            }

            try {
                // Here you would call the backend to delete
                console.log('Deleting pull-tab game:', gameId);

                this.loadPullTabLibrary(); // Refresh the library
                this.showAlert('Pull-tab game deleted successfully!', 'success');
            } catch (error) {
                console.error('Error deleting pull-tab game:', error);
                this.showAlert('Error deleting pull-tab game', 'error');
            }
        }
    }

    // Global functions
    let adminApp;

    document.addEventListener('DOMContentLoaded', function() {
        adminApp = new AdminInterface();
    });

    function showDashboard() { if (adminApp) adminApp.showDashboard(); }
    function showSessions() { if (adminApp) adminApp.showSessions(); }
    function showReports() { if (adminApp) adminApp.showReports(); }
    function showLibrary() { if (adminApp) adminApp.showLibrary(); }
    function generateOfflineApp() { if (adminApp) adminApp.generateOfflineApp(); }
    function createSession() { if (adminApp) adminApp.createSession(); }
    function closeSessionModal() { if (adminApp) adminApp.closeSessionModal(); }
    function buildOfflineApp() { if (adminApp) adminApp.buildOfflineApp(); }

    // Report generation functions
    function generateMonthlyReport() {
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        const monthSessions = adminApp.sessions.filter(s => {
            const sessionDate = new Date(s.date);
            return sessionDate.getMonth() === currentMonth && sessionDate.getFullYear() === currentYear;
        });

        const report = generateReportHTML('Monthly Summary Report', monthSessions, {
            title: `${new Date().toLocaleString('default', { month: 'long' })} ${currentYear} Summary`,
            includeComparison: true
        });

        openReportWindow(report);
    }

    function generateYearlyReport() {
        const currentYear = new Date().getFullYear();
        const yearSessions = adminApp.sessions.filter(s => {
            return new Date(s.date).getFullYear() === currentYear;
        });

        const report = generateReportHTML('Yearly Summary Report', yearSessions, {
            title: `${currentYear} Annual Report`,
            includeMonthlyBreakdown: true
        });

        openReportWindow(report);
    }

    function generateProfitLoss() {
        const report = generateFinancialReport(adminApp.sessions, 'Profit & Loss Statement');
        openReportWindow(report);
    }

    function generateTaxReport() {
        const currentYear = new Date().getFullYear();
        const yearSessions = adminApp.sessions.filter(s => {
            return new Date(s.date).getFullYear() === currentYear;
        });

        const report = generateTaxReport(yearSessions, currentYear);
        openReportWindow(report);
    }

    function generateAttendanceReport() {
        const report = generateAttendanceAnalysis(adminApp.sessions);
        openReportWindow(report);
    }

    function generateGameAnalysis() {
        const report = generateGamePerformanceReport(adminApp.sessions);
        openReportWindow(report);
    }

    function generatePullTabReport() {
        const report = generatePullTabAnalysisReport(adminApp.sessions);
        openReportWindow(report);
    }

    function generateVenueReport() {
        const report = generateSessionComparisonReport(adminApp.sessions);
        openReportWindow(report);
    }

    function generateCustomReport() {
        const startDate = document.getElementById('report-start').value;
        const endDate = document.getElementById('report-end').value;
        const reportType = document.getElementById('custom-report-type').value;

        if (!startDate || !endDate) {
            adminApp.showAlert('Please select start and end dates', 'warning');
            return;
        }

        const filteredSessions = adminApp.sessions.filter(s => {
            const sessionDate = new Date(s.date);
            return sessionDate >= new Date(startDate) && sessionDate <= new Date(endDate);
        });

        let report;
        switch(reportType) {
            case 'detailed':
                report = generateDetailedReport(filteredSessions, startDate, endDate);
                break;
            case 'comparison':
                report = generateComparisonReport(filteredSessions, startDate, endDate);
                break;
            default:
                report = generateReportHTML('Custom Summary Report', filteredSessions, {
                    title: `Custom Report: ${startDate} to ${endDate}`
                });
        }

        openReportWindow(report);
    }

    // Report generation helper functions
    function generateReportHTML(title, sessions, options = {}) {
        const totalSessions = sessions.length;
        const totalRevenue = sessions.reduce((sum, s) => sum + (s.totalRevenue || 0), 0);
        const totalProfit = sessions.reduce((sum, s) => sum + (s.netProfit || 0), 0);
        const avgPlayers = totalSessions > 0 ? Math.round(sessions.reduce((sum, s) => sum + (s.totalPlayers || 0), 0) / totalSessions) : 0;

        return `
        <!DOCTYPE html>
        <html>
        <head>
            <title>${title}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
                .header { text-align: center; border-bottom: 2px solid #2196F3; padding-bottom: 20px; margin-bottom: 30px; }
                .header h1 { color: #2196F3; margin: 0; }
                .header p { margin: 5px 0; color: #666; }
                .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
                .summary-card { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; }
                .summary-value { font-size: 2em; font-weight: bold; color: #2196F3; }
                .summary-label { color: #666; margin-top: 5px; }
                .table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                .table th { background: #f8f9fa; font-weight: bold; }
                .footer { text-align: center; color: #666; font-size: 12px; margin-top: 40px; border-top: 1px solid #ddd; padding-top: 20px; }
                @media print { .no-print { display: none; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>${options.title || title}</h1>
                <p>RLC Lions Club Bingo Operations</p>
                <p>Generated: ${new Date().toLocaleString()}</p>
            </div>

            <div class="summary">
                <div class="summary-card">
                    <div class="summary-value">${totalSessions}</div>
                    <div class="summary-label">Total Sessions</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">$${totalRevenue.toLocaleString()}</div>
                    <div class="summary-label">Total Revenue</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">$${totalProfit.toLocaleString()}</div>
                    <div class="summary-label">Total Profit</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${avgPlayers}</div>
                    <div class="summary-label">Avg Players</div>
                </div>
            </div>

            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Session</th>
                        <th>Lion in Charge</th>
                        <th>Players</th>
                        <th>Revenue</th>
                        <th>Profit</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${sessions.map(session => `
                        <tr>
                            <td>${new Date(session.date).toLocaleDateString()}</td>
                            <td>${CONFIG.SESSION_TYPES[session.sessionType] || session.sessionType}</td>
                            <td>${session.lionInCharge || 'N/A'}</td>
                            <td>${session.totalPlayers || 0}</td>
                            <td>$${(session.totalRevenue || 0).toLocaleString()}</td>
                            <td>$${(session.netProfit || 0).toLocaleString()}</td>
                            <td>${session.status}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>

            <div class="footer">
                <p>RLC Lions Club Bingo Manager - Report generated automatically</p>
                <button class="no-print" onclick="window.print()">Print Report</button>
                <button class="no-print" onclick="window.close()">Close</button>
            </div>
        </body>
        </html>
        `;
    }

    function openReportWindow(htmlContent) {
        const reportWindow = window.open('', '_blank');
        reportWindow.document.write(htmlContent);
        reportWindow.document.close();
    }

    function addPullTabGame() {
        const modal = createPullTabModal();
        document.body.appendChild(modal);
    }

    function createPullTabModal() {
        const modal = document.createElement('div');
        modal.id = 'pulltab-modal';
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
            align-items: center; justify-content: center;
        `;

        modal.innerHTML = `
            <div class="card" style="max-width: 500px; width: 90%; max-height: 80%; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Add Pull-Tab Game</h3>
                    <button onclick="closePullTabModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                </div>

                <form id="pulltab-form">
                    <div class="form-group">
                        <label for="pt-name">Game Name</label>
                        <input type="text" id="pt-name" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="pt-price">Ticket Price</label>
                        <select id="pt-price" class="form-control" required>
                            <option value="0.25">$0.25</option>
                            <option value="0.50">$0.50</option>
                            <option value="1">$1.00</option>
                            <option value="2">$2.00</option>
                            <option value="5">$5.00</option>
                            <option value="10">$10.00</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="pt-tickets">Tickets per Game</label>
                        <input type="number" id="pt-tickets" class="form-control" required min="1">
                    </div>

                    <div class="form-group">
                        <label for="pt-profit">Ideal Profit %</label>
                        <input type="number" id="pt-profit" class="form-control" required min="0" max="100" step="0.1">
                    </div>

                    <div class="form-group">
                        <label for="pt-manufacturer">Manufacturer</label>
                        <select id="pt-manufacturer" class="form-control" required>
                            <option value="">Select...</option>
                            <option value="Arrow">Arrow</option>
                            <option value="Bingo King">Bingo King</option>
                            <option value="Pickle Cards">Pickle Cards</option>
                            <option value="Houdini">Houdini</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="pt-form-number">Form Number</label>
                        <input type="text" id="pt-form-number" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="pt-status">Status</label>
                        <select id="pt-status" class="form-control">
                            <option value="Active">Active</option>
                            <option value="Discontinued">Discontinued</option>
                            <option value="Special Event">Special Event</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn secondary" onclick="closePullTabModal()">Cancel</button>
                        <button type="submit" class="btn success">Add Game</button>
                    </div>
                </form>
            </div>
        `;

        modal.querySelector('#pulltab-form').addEventListener('submit', (e) => {
            e.preventDefault();
            savePullTabGame();
        });

        return modal;
    }

    function closePullTabModal() {
        const modal = document.getElementById('pulltab-modal');
        if (modal) {
            modal.remove();
        }
    }

    function savePullTabGame() {
        const gameData = {
            name: document.getElementById('pt-name').value,
            ticketPrice: parseFloat(document.getElementById('pt-price').value),
            ticketsPerGame: parseInt(document.getElementById('pt-tickets').value),
            idealProfitPercent: parseFloat(document.getElementById('pt-profit').value),
            manufacturer: document.getElementById('pt-manufacturer').value,
            formNumber: document.getElementById('pt-form-number').value,
            status: document.getElementById('pt-status').value,
            id: Date.now() // Simple ID generation for demo
        };

        // Here you would save to backend
        console.log('Saving pull-tab game:', gameData);

        closePullTabModal();
        adminApp.loadPullTabLibrary(); // Refresh the library
        adminApp.showAlert('Pull-tab game added successfully!', 'success');
    }
    function previewOfflineApp() { alert('Offline app preview not yet implemented'); }
    function backupData() { alert('Data backup not yet implemented'); }

    </script>
</body>
</html>
